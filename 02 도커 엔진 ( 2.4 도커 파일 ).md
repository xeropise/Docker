## Dockerfile

### 이미지를 생성하는 방법

- 개발한 애플리케이션을 컨테이너화할 떄 가장 먼저 생각나는 방법은 아래와 같다.

  - 아무것도 존재하지 않는 이미지(Ubuntu, CentOS 등)로 컨테이너를 생성

  - 애플리케이션을 위한 환경을 설치하고 소스코드 등을 복사해 잘 동작하는 것을 확인

  - 컨테이너를 이미지로 커밋(commit)

- 위 방법의 경우 애플리케이션이 동작하는 환경을 구성하기 위해 일일이 수작업으로 패키지를 설치하고 소스코드를 깃에서 복제하거나 호스트에서 복사해야 한다.

- 도커는 위와 같은 일련의 과정을 손쉽게 기록하고 수행할 수 있는 build 명령어를 제공한다.

- 완성된 이미지를 생성하기 위해 컨테이너에 설치해야 하는 패키지, 추가해야 하는 소스코드, 실행해야 하는 명령어와 쉘 스크립트 등을 하나의 파일에 기록해 두면 도커는 이 파일을 읽어 컨테이너에서 작업을 수행한 뒤 이미지로 만들어낸다.

- 위의 작업을 기록한 파일 이름을 Dockerfile 이라고 하고 build 명령어는 Dockerfile 을 읽어 이미지를 생성한다. Dockerfile 을 사용하면 직접 컨테이너를 생성하고 이미지로 커밋해야 하는 번거로움을 덜 수 있을뿐더러 깃과 같은 개발 도구를 통해 애플리케이션의 빌드 및 배포를 자동화할수 있다.

- 개발하는 용도 외에도, 도커 허브 등을 통해 배포할 떄 이미지 자체를 배포하는 대신 이미지를 생성하는 방법을 기록해 놓은 Dockerfile을 배포할 수도 있다.

---

### Dockerfile 작성

- [Dockerfile을 작성](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)하기 위해서는 Dockerfile에서 쓰이는 명령어를 알아둘 필요가 있다.

- 간단한 웹 서버 이미지를 생성하는 예는 다음과 같다.

```
# mkdir dockerfile && cd dockerfile
# echo test >> test.html

# ls
test.html
```

```
# vi Dockerfile

FROM ubuntu:14.04
MAINTAINER xeropise
LABEL "purpose"="pratice"
RUN apt-get update
RUN apt-get install apache2 -y
ADD test.html /var/www/html
WORKDIR /var/www/html
RUN ["/bin/bash", "-c", "echo hello >> test2.html"]
EXPOSE 80
CMD apachectl -DFOREGROUND
```

- 명령어를 소문자로 표기해도 상관은 없지만 일반적으로 대문자를 표기한다. 위의 예시에서 사용한 명령어에 대한 설명은 다음과 같다.

  - FROM : 생성할 이미지의 베이스가 될 이미지를 말한다. Dockerfile 작성을 위해서는 반드시 한 번 이상 입력해야 한다. 사용하려는 이미지가 없는 경우 자동으로 pull 한다.

  - MAINTAINER : 이미지를 생성한 개발자의 정보를 나타낸다. LABEL 로 교체해 표현할 수 있다.

  - LABEL : 이미지에 메타데이터를 추가한다. '키:값' 형태로 저장되며, 여러 개의 메타데이터가 저장될 수 있다. 추가된 메타데이터는 docker inspect 명령어로 확인할 수 있다.

  - RUN : 이미지를 만들기 위해 컨테이너 내부에서 명령어를 실행한다.인자를 필요하는 명령어를 위해 배열 형태로 입력할 수 있다.

  - ADD : 파일을 이미지에 추가한다. Dockerfile이 위치한 디렉터리인 컨텍스트에서 가져온다. 위의 경우 test.html 파일을 /var/www/html 디렉터리에 추가한다.

  - WORKDIR : 명령어를 실행할 디렉터리르 나타낸다. 배시 쉘에서 cd 명령어를 입력하는 것과 같다.

  - EXPOSE : Dockerfile 의 빌드로 생성된 이미지에서 노출할 포트를 설정한다. EXPOSE 로 설정한 이미지로 컨테이너를 생성했다고 반드시 이 포트가 호스트의 포트와 바인딩되는 것은 아니며, 단지 컨테이너의 80번 포트를 사용할 것임을 나타낸다.

  - CMD : 컨테이너가 시작될 떄마다 실행할 명령어를 설정, Dockerfile 에서 한 번만 사용할 수 있다.

- 이외에도 여러 명령어가 있으니 참조하여 사용하도록 하자. 자세한 것은 책 참조

---

### Dockerfile 빌드과정

- build 명령어는 Dockerfile 에 기록된 대로 컨테이너를 실행한 뒤 완성된 이미지를 만들어 내는데 이미지로 만드는 과정이 하나의 컨테이너에서 일어나는 것은 아니다.

- 각 Step 해당되는 명령어가 실행될 때마다 새로운 컨테이너가 하나씩 생성되며 이를 이미지로 커밋한다. 즉, Dockerfile 에서 명령어 한 줄이 실행될 때마다 이전 Step 에서 생성된 이미지에 의해 새로운 컨테이너가 생성되며, Dockerfile 에 적힌 명령어를 수행하고 다시 새로운 이미지 레이어로 저장된다.

- 이미지의 빌드가 완료되면 Dockerfile의 명령어 줄 수만큼 레이어가 존재하게 되고, 중간에 컨테이너도 같은 수만큼 생성되고 삭제된다. 중간에 Removing intermediate container 를 통해 임시로 생성된 컨테이너를 삭제한다.

---

### Docker build 시 캐시, 멀티 스테이징 이용

- 책을 참조하자. 이를 이용해서 build 된 이미지의 크기를 줄일 수 있다.

---

### Dockerfile 로 빌드할 때 주의할 점

- 하나의 명령어를 \ 로 나눠 가독성을 높일 수 있도록 한다.

- .dockerignore 파일을 작성해 불필요한 파일을 빌드 컨텍스트에 포함하지 않도록 한다.

- 빌드 캐시를 이용해 기존에 사용했던 이미지 레이어를 재사용하자.

- Dockerfile 을 아무렇게나 작성하면 저장 공간을 불필요하게 차지하는 이미지나 레이어가 너무 많이 생성되므로 예로 RUN 명령어를 수행하는 경우 && 로 하나로 묶어 여러 개의 명령어를 실행하도록 작성하면 하나의 이미지 레이어가 된다.

- 다른 사람이 빌드한 이미지에 불필요한 이미지 레이어가 들어있다면 해당 이미지로 컨테이너를 생성하고 docker export, import 명령어를 사용해 컨테이너를 이미지로 만듦으로써 이미지의 크기를 줄일수도 있다.

- export 된 파일을 임포트해서 다시 도커에 저장하면 레이어가 한개로 줄어든다. 단, 이전 이미지에 저장되어 있던 각종 이미지 설정은 잃어버리게 되므로 주의하자.
